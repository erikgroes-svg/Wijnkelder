<!DOCTYPE html>
<html lang="nl">
<head>
 <link rel="manifest" href="/manifest.json" />

<meta name="theme-color" content="#ffffff" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Wijnkelder" />

<link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-card: #ffffff;
      --border-subtle: #e2e2e7;
      --text-main: #222222;
      --text-muted: #6c6c73;
      --accent: #0f62fe;
      --accent-soft: #eef3ff;
      --danger: #d12727;
      --success: #167d3b;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #ffffffcc;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid #e1e1e6;
      padding: 14px 28px;
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    header .title-left { display: flex; align-items: center; gap: 10px; }
    header span.logo { font-size: 26px; }
    header .subtitle-top {
      font-size: 11px; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.08em;
      font-weight: 500;
    }

    .container {
      max-width: 1120px;
      margin: auto;
      padding: 22px 16px 32px;
    }

    .panel-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }
    .small { font-size: 11px; color: var(--text-muted); }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 18px 18px 20px;
      margin-bottom: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    input, select, textarea {
      padding: 8px 10px;
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d5d5dd;
      font-size: 14px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      font-family: inherit;
      background: #fff;
      color: var(--text-main);
    }

    textarea { min-height: 60px; resize: vertical; }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(15,98,254,0.18);
      background: #f8f9ff;
    }

    label { font-size: 12px; display:block; margin-top: 8px; margin-bottom: 3px; color: var(--text-muted); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }

    th {
      background: #f2f2f7;
      text-align: left;
      padding: 8px 8px;
      font-weight: 600;
      white-space: nowrap;
      font-size: 12px;
      color: var(--text-muted);
      border-bottom: 1px solid #e0e0e6;
    }

    td {
      padding: 7px 8px;
      border-bottom: 1px solid #f0f0f4;
      vertical-align: top;
    }

    tbody tr:nth-child(even) { background: #fafafa; }
    tbody tr:hover { background: #eef3ff; }

    /* numerieke kolommen rechts */
    #wineTable td:nth-child(4),
    #wineTable td:nth-child(5),
    #wineTable td:nth-child(6),
    #wineTable th:nth-child(4),
    #wineTable th:nth-child(5),
    #wineTable th:nth-child(6) { text-align: right; }

    .btn-primary, .btn-ghost {
      padding: 8px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.12s ease, color 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 18px rgba(15,98,254,0.25);
    }
    .btn-primary:hover { background: #0b55da; }

    .btn-ghost {
      background: #f2f2f7;
      color: var(--text-main);
      border-color: #e0e0ea;
    }
    .btn-ghost:hover { background: #e4e4f0; }

    .pill-row { display:flex; flex-wrap:wrap; gap:8px; margin-top: 8px; }
    .pill {
      padding: 5px 11px;
      border-radius: var(--radius-pill);
      border: 1px solid #d5d5dd;
      font-size: 12px;
      cursor: pointer;
      background: #fff;
      color: var(--text-muted);
    }
    .pill.active { border-color: var(--accent); background: var(--accent-soft); color: #0b3c8c; }

    .view-switch {
      display: inline-flex;
      border-radius: var(--radius-pill);
      background: #f2f2f7;
      padding: 3px;
      border: 1px solid #e0e0ea;
      margin-bottom: 6px;
    }
    .view-switch button {
      border-radius: var(--radius-pill);
      border: none;
      padding: 5px 12px;
      background: transparent;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
    }
    .view-switch button.active {
      background: #fff;
      color: var(--text-main);
      box-shadow: 0 0 0 1px #e0e0ea;
    }

    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      background: #f2f2f7;
      margin-left: 4px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .tag-danger { background: #ffe6e6; color: var(--danger); }
    .tag-ok { background: #e4f7ea; color: var(--success); }
    .chip-badge {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      background: #e1f0ff;
      margin-left: 4px;
      color: #0b3c8c;
      font-weight: 700;
    }

    .inline-actions { display:flex; gap: 6px; flex-wrap: wrap; }
    .btn-small {
      padding: 5px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid #d5d5dd;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-main);
      font-weight: 600;
    }
    .btn-small:hover { background:#eef3ff; border-color: var(--accent); }

    .sommelier-result {
      margin-top: 10px;
      padding: 10px 12px;
      background: #f2f7ff;
      border-left: 3px solid var(--accent);
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.5;
    }

    .sommelier-row { display:flex; flex-wrap:wrap; gap: 6px; margin-top: 8px; }
    .sommelier-chip {
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      background: #f2f2f7;
      border: 1px solid #dddded;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-main);
      font-weight: 600;
    }

    .grid-add { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 10px 12px; }

    .summary-bar { display:flex; flex-wrap:wrap; gap: 8px; margin: 6px 0 4px; font-size: 13px; }
    .summary-item {
      background: #f7f7fb;
      border-radius: var(--radius-pill);
      padding: 5px 11px;
      display:inline-flex;
      align-items: baseline;
      gap: 6px;
      border: 1px solid #e2e2ee;
    }
    .summary-item span.value { font-weight: 800; color: var(--text-main); }

   @media (max-width: 768px) {
  .wine-footer { margin-top: 10px; color: var(--text-muted); }
}

@media (max-width: 768px) {
  .wine-card { padding: 12px; margin: 10px 10px; }
  .wine-badges { margin-top: 8px; }
  .actions-primary { margin-top: 10px; }
}
@media (max-width: 768px) {
  header {
    padding: 10px 12px;
    padding-top: calc(10px + env(safe-area-inset-top));
  }

  header span.logo { font-size: 22px; }
  header .btn-ghost { padding: 8px 10px; font-size: 12px; }
}

  @media (max-width: 768px) {
  .btn-action{
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.10);
    background: #fff;
    font-size: 13px;
    font-weight: 700;
  }

  .btn-action.primary{
    background: var(--accent);
    border-color: transparent;
    color: #fff;
    box-shadow: 0 10px 22px rgba(15,98,254,0.22);
  }

  .btn-action.secondary{
    background: #f2f2f7;
  }

  details.more-actions > summary{
    border-radius: 14px;
    background: #f2f2f7;
  }

  .qty{
    min-width: 40px;
    height: 40px;
    border-radius: 12px;
    font-size: 15px;
  }
}

    /* iPhone / small screens */
  @media (max-width: 768px) {
  table thead {
    display: none;
  }

  table, tbody, tr, td {
    display: block;
    width: 100%;
  }

  tr {
    margin-bottom: 12px;
  }

  td {
    border: none;
    padding: 0;
  }
}
@media (max-width: 768px) {
  tr {
    background: #fff;
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 16px;
    padding: 14px;
    margin: 12px;
  }
}
@media (max-width: 768px) {
  td:first-child {
    font-size: 12px;
    opacity: 0.7;
    display: inline-block;
    margin-right: 8px;
  }
}
/* Mobile-first: cards i.p.v. tabel */
.wine-cards { display: none; }

   @media (max-width: 768px) {
  .card .subtitle.small { display: none; }
}

@media (max-width: 768px) {
  /* verberg de tabel volledig op mobiel */
  #wineTable { display: none; }
  .wine-cards { display: block; }

  /* compacter header padding op mobiel */
  header { padding: 12px 14px; }
  header .subtitle-top { display:none; } /* scheelt veel hoogte */

  .wine-card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 16px;
    padding: 14px;
    margin: 10px 8px;
    box-shadow: var(--shadow-soft);
  }

  .wine-top {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
  }

  .wine-left { min-width: 0; }
  .wine-title {
    font-size: 16px;
    font-weight: 700;
    line-height: 1.2;
    margin: 0;
  }

  .wine-meta {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .wine-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }

  .wine-right { text-align: right; flex: 0 0 auto; }

  .qty {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    height: 44px;
    padding: 0 10px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.10);
    background: #fff;
    font-size: 16px;
    font-weight: 800;
  }

  .actions-primary {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .btn-action {
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid #d5d5dd;
    background: #fff;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
  }

  details.more-actions { margin-top: 10px; }
  details.more-actions > summary {
    list-style: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid #d5d5dd;
    background: #f2f2f7;
    font-size: 13px;
    font-weight: 700;
  }
  details.more-actions > summary::-webkit-details-marker { display:none; }

  .more-grid {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
}

    /* Error banner for debugging */
    #errorBanner {
      display:none;
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      background: #1b1b1b;
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      z-index: 9999;
      font-size: 12px;
      line-height: 1.35;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      white-space: pre-wrap;
    }
   
  </style>
</head>
<body>

<div id="errorBanner"></div>

<header>
  <div class="title-left">
    <span class="logo">üç∑</span>
    <div>
      Mijn Wijnkelder
      <div class="subtitle-top">Voorraad ¬∑ Locaties ¬∑ Sommelier</div>
    </div>
  </div>
  <button class="btn-ghost" onclick="resetAll()">Reset lokale wijzigingen</button>
</header>

<div class="container">

  <div class="card">
    <div class="panel-title">Zoeken &amp; filteren</div>
    <div class="subtitle">Bekijk alle wijnen of enkel degene die nu op dronk zijn. Filter per vak of type, en zoek op naam, notities of foodpairing.</div>

    <div class="view-switch">
      <button id="viewAll" class="active" onclick="setView('all')">Alle wijnen</button>
      <button id="viewOnDrink" onclick="setView('onDrink')">Nu op dronk</button>
    </div>

    <input id="searchInput" type="text" placeholder="Zoek op naam, druif, notities..." oninput="renderTable()" />

    <div style="margin-top:10px;">
      <select id="vakFilter" onchange="renderTable()">
        <option value="">‚Äî Filter op vak ‚Äî</option>
      </select>
    </div>

    <div class="pill-row">
      <div class="pill" onclick="quickFilter('wit')" data-type="wit">Wit</div>
      <div class="pill" onclick="quickFilter('rood')" data-type="rood">Rood</div>
      <div class="pill" onclick="quickFilter('bubbels')" data-type="bubbels">Mousserend</div>
      <div class="pill" onclick="quickFilter('dessert')" data-type="dessert">Dessert / zoet</div>
      <div class="pill" onclick="clearTypeFilter()">Type wissen</div>
    </div>
  </div>

  <div class="card">
    <div class="panel-title">Overzicht &amp; voorraad</div>
    <div class="subtitle small">
      Gebruik <strong>Fles genomen</strong> om de voorraad aan te passen. Met <strong>Locatie wijzigen</strong> kun je het vak corrigeren. Met <strong>Prijs instellen</strong> bewaar je een prijs per fles.
    </div>

    <div style="margin:8px 0 4px; display:flex; gap:8px; flex-wrap:wrap;">
      <button type="button" class="btn-ghost" onclick="autoFillAllDrinkWindows()">Drinkvenster aanvullen</button>
      <button type="button" class="btn-ghost" onclick="autoFillAllFoodpairings()">Foodpairing aanvullen</button>
    </div>
<div style="margin:8px 0 4px; display:flex; gap:8px; flex-wrap:wrap;">
  <button type="button" class="btn-ghost" onclick="autoFillAllDrinkWindows()">Drinkvenster aanvullen</button>
  <button type="button" class="btn-ghost" onclick="autoFillAllFoodpairings()">Foodpairing aanvullen</button>

  <button type="button" class="btn-ghost" onclick="exportData()">Export (JSON)</button>
  <button type="button" class="btn-ghost" onclick="triggerImport()">Import (JSON)</button>
  <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importData(event)" />
</div>

    <div id="summaryBar" class="summary-bar"></div>
    <div id="wineCards" class="wine-cards"></div>

    <table id="wineTable">
      <thead>
        <tr>
          <th>Vak</th>
          <th>Wijn</th>
          <th>Jaar</th>
          <th>Aantal</th>
          <th>Prijs<br><span class="small">(‚Ç¨/fles)</span></th>
          <th>Waarde<br><span class="small">(totaal)</span></th>
          <th>Drinkvenster</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <div class="panel-title">Sommelier (compact)</div>
    <div class="subtitle small">Snelle suggesties uit je eigen kelder. Kies een type gerecht of typ zelf iets in.</div>

    <input id="dishInput" type="text" placeholder="Bijv. kip in room-tomatensaus" />

    <div class="sommelier-row">
      <button type="button" class="sommelier-chip" onclick="setDishAndSuggest('kip in room-tomatensaus')">Kip (roomsaus)</button>
      <button type="button" class="sommelier-chip" onclick="setDishAndSuggest('c√¥te √† l‚Äôos op de grill')">Rund / grill</button>
      <button type="button" class="sommelier-chip" onclick="setDishAndSuggest('gebakken vis')">Vis</button>
      <button type="button" class="sommelier-chip" onclick="setDishAndSuggest('aperitiefhapjes')">Aperitief</button>
    </div>

    <button class="btn-primary" style="margin-top:8px;" onclick="suggestWine()">
      <span>Geef advies</span> <span>‚ú®</span>
    </button>

    <div id="sommelierResult"></div>
  </div>

  <div class="card">
    <div class="panel-title">Nieuwe fles toevoegen</div>
    <div class="subtitle small">Velden <strong>Vak</strong> en <strong>Wijn</strong> zijn verplicht.</div>

    <form id="addForm" onsubmit="addWine(event)">
      <div class="grid-add">
        <div>
          <label for="addVak">Vak *</label>
          <input id="addVak" type="number" min="0" step="1" required />
        </div>
        <div>
          <label for="addWijn">Wijn *</label>
          <input id="addWijn" type="text" required />
        </div>
        <div>
          <label for="addJaargang">Jaargang</label>
          <input id="addJaargang" type="number" min="1900" max="2100" />
        </div>
        <div>
          <label for="addType">Type</label>
          <select id="addType">
            <option value="">Automatisch bepalen</option>
            <option value="wit">Wit</option>
            <option value="rood">Rood</option>
            <option value="rose">Ros√©</option>
            <option value="bubbels">Mousserend</option>
          </select>
        </div>
        <div>
          <label for="addAantal">Aantal</label>
          <input id="addAantal" type="number" min="1" step="1" value="1" />
        </div>
        <div>
          <label for="addAankoopPrijs">Aankoopprijs (‚Ç¨/fles)</label>
          <input id="addAankoopPrijs" type="number" min="0" step="0.01" placeholder="Bijv. 15" />
        </div>
        <div>
          <label for="addHuidigePrijs">Huidige prijs (‚Ç¨/fles)</label>
          <input id="addHuidigePrijs" type="number" min="0" step="0.01" placeholder="Optioneel" />
        </div>
        <div>
          <label for="addDrinkvenster">Drinkvenster</label>
          <input id="addDrinkvenster" type="text" placeholder="Bijv. 2025‚Äì2028 of Nu drinken" />
        </div>
        <div>
          <label for="addServeer">Serveertemperatuur</label>
          <input id="addServeer" type="text" placeholder="Bijv. 8‚Äì10¬∞C" />
        </div>
      </div>

      <label for="addFood">Foodpairing</label>
      <input id="addFood" type="text" placeholder="Bijv. geitenkaas, asperges, lichte vis" />

      <label for="addNotes">Notities</label>
      <textarea id="addNotes" placeholder="Bijv. frisse stijl, citrus, ideaal als aperitief."></textarea>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button type="submit" class="btn-primary">Fles toevoegen</button>
        <button type="button" class="btn-ghost" onclick="clearAddForm()">Formulier leegmaken</button>
      </div>
    </form>
  </div>

</div>

<script>
/* Show JS errors on screen (crucial for iPhone debugging) */
(function () {
  const banner = document.getElementById("errorBanner");
  function show(msg) {
    banner.style.display = "block";
    banner.textContent = "FOUT in app:\n" + msg;
  }
  window.addEventListener("error", (e) => {
    show((e.message || "Onbekende fout") + (e.lineno ? ("\nRegel: " + e.lineno) : ""));
  });
  window.addEventListener("unhandledrejection", (e) => {
    show("Promise fout: " + (e.reason && e.reason.message ? e.reason.message : String(e.reason)));
  });
})();
</script>
</script>

<script>
// Export / Import helpers + prijs-normalisatie

function exportData() {
  const payload = {
    exportedAt: new Date().toISOString(),
    wines
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "wijnkelder-export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

function triggerImport() {
  document.getElementById("importFile").click();
}

function normalizePrices(w) {
  // Als reeds aanwezig: ok
  if (w.PrijsHuidig != null || w.PrijsAankoop != null) return w;

  // Veelvoorkomende alternatieve keys (oude versies / imports)
  const candidates = [
    w.Prijs, w.prijs,
    w.Aankoopprijs, w.aankoopprijs,
    w.AankoopPrijs, w.aankoopPrijs,
    w.PrijsPerFles, w.prijsPerFles,
    w.price, w.Price
  ];

  const raw = candidates.find(v => v != null && String(v).trim() !== "");
  if (raw == null) return w;

  const val = parseFloat(String(raw).replace(",", "."));
  if (!isNaN(val) && val >= 0) {
    // Als we slechts √©√©n prijs kennen: zet die als aankoopprijs
    w.PrijsAankoop = val;
  }
  return w;
}

async function importData(event) {
  const file = event.target.files && event.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const parsed = JSON.parse(text);

    const imported = Array.isArray(parsed) ? parsed : parsed.wines;
    if (!Array.isArray(imported)) throw new Error("Ongeldig exportbestand (geen wines-array).");

    // Normaliseer + zorg dat _id bestaat + prijzen normaliseren
    const normalized = imported.map((w, idx) => {
      const obj = {
        ...w,
        _id: (w._id != null) ? w._id : (idx + 1),
        Type: w.Type || guessType(w.Wijn),
        Aantal: (w.Aantal == null || isNaN(w.Aantal)) ? 0 : Number(w.Aantal)
      };
      return normalizePrices(obj);
    });

    wines = normalized;
    await saveData();
    fillVakFilter();
    renderTable();

    alert("Import gelukt. Data is nu bijgewerkt op dit toestel.");
  } catch (e) {
    alert("Import mislukt: " + (e && e.message ? e.message : String(e)));
  } finally {
    event.target.value = "";
  }
}
</script>

<script>
// Basisdata (embedded)
const baseWines = [
  ...
];
</script>

let wines = [];
let currentView = "all";

/* IndexedDB = stabiel op iPhone/PWA */
const DB_NAME = "wijnkelderDB";
const DB_VERSION = 1;
const STORE_NAME = "wines";

/* Legacy keys blijven nuttig: √©√©nmalige import uit localStorage */
const LEGACY_STORAGE_KEYS = [
  "wijnkelderData_v7_fp",
  "wijnkelderData_v7",
  "wijnkelderData_v6",
  "wijnkelderData_v5",
  "wijnkelderData"
];

function guessType(name) {
  if (!name) return "onbekend";
  const n = name.toLowerCase();
  if (n.includes("ros√©") || n.includes(" rose ")) return "rose";
  if (n.includes("champagne") || n.includes("cava") || n.includes("prosecco") || n.includes("cr√©mant")) return "bubbels";
  if (n.includes("riesling") || n.includes("sauvignon") || n.includes("chardonnay") || n.includes("pinot grigio") || n.includes("veltliner") || n.includes("viognier")) return "wit";
  if (n.includes("barolo") || n.includes("barbera") || n.includes("nebbiolo") || n.includes("rioja") || n.includes("malbec") || n.includes("cabernet") || n.includes("merlot") || n.includes("syrah") || n.includes("shiraz") || n.includes("amarone") || n.includes("valpolicella")) return "rood";
  return "onbekend";
}

function isOnDrink(drinkvenster) {
  if (!drinkvenster) return false;
  const txt = String(drinkvenster).toLowerCase();
  const year = new Date().getFullYear();

  if (txt.includes("nu drinken") || txt.includes("nu op dronk") || txt.trim() === "nu") return true;

  const rangeMatch = txt.match(/(\d{4})\D+(\d{4})/);
  if (rangeMatch) {
    const start = parseInt(rangeMatch[1], 10);
    const end = parseInt(rangeMatch[2], 10);
    return year >= start && year <= end;
  }

  const singleMatch = txt.match(/(\d{4})/);
  if (singleMatch) {
    const y = parseInt(singleMatch[1], 10);
    return Math.abs(year - y) <= 1;
  }
  return false;
}

function estimateDrinkWindowForWine(w) {
  const nowYear = new Date().getFullYear();
  const y = parseInt(w.Jaargang, 10);
  if (!y || isNaN(y)) return null;

  const type = guessType(w.Wijn);
  const name = (w.Wijn || "").toLowerCase();
  let start, end;

  if (type === "wit") { start = Math.max(y + 1, nowYear); end = start + 4; }
  else if (type === "bubbels") {
    if (name.includes("champagne") || name.includes("gimonnet") || name.includes("de venoge")) { start = Math.max(y + 2, nowYear); end = start + 8; }
    else { start = Math.max(y, nowYear); end = start + 5; }
  } else if (type === "rood") {
    if (name.includes("barolo") || name.includes("amarone") || name.includes("valpolicella") || name.includes("pingus") || name.includes("dal forno") || name.includes("ribera")) {
      start = Math.max(y + 5, nowYear); end = start + 15;
    } else if (name.includes("riserva") || name.includes("superiore")) {
      start = Math.max(y + 3, nowYear); end = start + 10;
    } else {
      start = Math.max(y + 2, nowYear); end = start + 6;
    }
  } else { start = Math.max(y + 1, nowYear); end = start + 5; }

  if (end < start) end = start + 1;
  return `${start}‚Äì${end}`;
}

function estimateFoodpairingForWine(w) {
  const name = (w.Wijn || "").toLowerCase();
  const type = guessType(w.Wijn);

  if (type === "bubbels" || name.includes("champagne") || name.includes("cava")) {
    return "Aperitief, oesters, zeevruchten, sushi en lichte hapjes";
  }
  if (type === "wit") {
    if (name.includes("sauvignon") || name.includes("assyrtiko") || name.includes("riesling")) return "Geitenkaas, salades, asperges, zeevruchten en lichte visgerechten";
    if (name.includes("chardonnay")) return "Gevogelte, romige sauzen, rijke visgerechten en kreeft";
    return "Visgerechten, schaal- en schelpdieren, salades en lichte witvleesgerechten";
  }
  if (type === "rood") {
    if (name.includes("barolo") || name.includes("nebbiolo")) return "Rood vlees, wild, truffelgerechten en gerijpte harde kazen";
    if (name.includes("amarone") || name.includes("valpolicella") || name.includes("ripasso")) return "Wild, stoofpotten, krachtige vleesgerechten en gerijpte kazen";
    if (name.includes("pinot noir")) return "Eend, gevogelte, kalfsvlees en gerechten met paddenstoelen";
    return "Gegrild vlees, stoofpotten, charcuterie en gerijpte kazen";
  }
  return "Algemene vlees- en pastagerechten, gegrilde groenten en kazen";
}

async function initData() {
  // 1) Eerst DB proberen
  let dbWines = [];
  try {
    dbWines = await idbGetAll();
  } catch (e) {
    console.warn("IndexedDB read failed:", e);
  }

  // 2) Als DB leeg is: migreren uit localStorage (oude keys)
  if (!dbWines || dbWines.length === 0) {
    let legacyRaw = null;

    for (const k of LEGACY_STORAGE_KEYS) {
      const v = localStorage.getItem(k);
      if (v) { legacyRaw = v; break; }
    }

    if (legacyRaw) {
      try {
        const legacyWines = JSON.parse(legacyRaw) || [];

        // normaliseren + unieke _id
        const migrated = legacyWines.map((w, idx) => ({
          ...w,
          _id: (w._id != null) ? w._id : (idx + 1)
        }));

        await idbPutAll(migrated);

        // legacy keys opruimen zodat er geen ‚Äúdubbele waarheid‚Äù bestaat
        LEGACY_STORAGE_KEYS.forEach(k => localStorage.removeItem(k));

        dbWines = migrated;
        console.log("Migratie localStorage ‚Üí IndexedDB uitgevoerd");
      } catch (e) {
        console.warn("Legacy parse failed:", e);
      }
    }
  }

  // 3) Nog steeds leeg? seed baseWines
  if (!dbWines || dbWines.length === 0) {
    const seeded = baseWines.map((w, idx) => ({ ...w, _id: idx + 1 }));
    await idbPutAll(seeded);
    dbWines = seeded;
    console.log("BaseWines ‚Üí IndexedDB seeded");
  }

  // 4) In-memory + normalisatie
  wines = dbWines;

 wines.forEach((w, idx) => {
  if (w._id == null) w._id = idx + 1;
  if (w.Aantal == null || isNaN(w.Aantal)) w.Aantal = 0;
  if (!w.Type) w.Type = guessType(w.Wijn);

  normalizePrices(w);
});

}

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);

    req.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "_id" });
      }
    };

    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbGetAll() {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

async function idbPutAll(items) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);

    const clearReq = store.clear();
    clearReq.onerror = () => reject(clearReq.error);

    clearReq.onsuccess = () => {
      (items || []).forEach(item => store.put(item));
    };

    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function idbClear() {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);
    const req = store.clear();
    req.onsuccess = () => resolve(true);
    req.onerror = () => reject(req.error);
  });
}

async function saveData() {
  await idbPutAll(wines);
}

function fillVakFilter() {
  const filter = document.getElementById("vakFilter");
  filter.innerHTML = '<option value="">‚Äî Filter op vak ‚Äî</option>';

  const uniqueVakken = [...new Set(wines.map(w => w.Vak))]
    .filter(v => v !== null && v !== undefined && v !== "" && !Number.isNaN(v))
    .sort((a, b) => Number(a) - Number(b));

  uniqueVakken.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = "Vak " + v;
    filter.appendChild(opt);
  });
}

function setView(view) {
  currentView = view;
  document.getElementById("viewAll").classList.toggle("active", view === "all");
  document.getElementById("viewOnDrink").classList.toggle("active", view === "onDrink");
  renderTable();
}

function updateSummary() {
  const el = document.getElementById("summaryBar");
  if (!el) return;

  let totalBottles = 0;
  let totalValue = 0;

  wines.forEach(w => {
    const aantal = Number(w.Aantal || 0);
    if (!isNaN(aantal)) totalBottles += aantal;

    const price = w.PrijsHuidig != null ? Number(w.PrijsHuidig)
      : w.PrijsAankoop != null ? Number(w.PrijsAankoop)
      : null;

    if (price != null && !isNaN(price)) totalValue += aantal * price;
  });

  const valueText = totalValue > 0 ? `‚Ç¨ ${totalValue.toFixed(0)}` : "‚Äî";

  el.innerHTML = `
    <div class="summary-item"><span>Totaal flessen</span> <span class="value">${totalBottles}</span></div>
    <div class="summary-item"><span>Totale waarde</span> <span class="value">${valueText}</span></div>
  `;
}

function renderTable() {
  const tbody = document.querySelector("#wineTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  const cards = document.getElementById("wineCards");
  if (cards) cards.innerHTML = "";

  const search = (document.getElementById("searchInput").value || "").toLowerCase();
  const vak = document.getElementById("vakFilter").value;
  const activePill = document.querySelector(".pill.active[data-type]");
  const typeFilter = activePill ? activePill.getAttribute("data-type") : null;

  const rows = wines
    .map((w, idx) => ({ w, idx }))
    .filter(({ w }) => {
      if (currentView === "onDrink" && !isOnDrink(w.Drinkvenster)) return false;
      if (vak !== "" && String(w.Vak) !== String(vak)) return false;

      if (search) {
        const inName = (w.Wijn || "").toLowerCase().includes(search);
        const inNotes = (w.Notities || "").toLowerCase().includes(search);
        const inFood = (w.Foodpairing || "").toLowerCase().includes(search);
        if (!inName && !inNotes && !inFood) return false;
      }

      if (typeFilter) {
        const t = w.Type || guessType(w.Wijn);
        if (typeFilter === "dessert") {
          const fp = (w.Foodpairing || "").toLowerCase();
          const nt = (w.Notities || "").toLowerCase();
          if (!(fp.includes("dessert") || nt.includes("dessert"))) return false;
        } else if (t !== typeFilter) return false;
      }

      return true;
    })
    .sort((a, b) => {
      const vakA = (a.w.Vak == null || Number.isNaN(a.w.Vak)) ? 9999 : Number(a.w.Vak);
      const vakB = (b.w.Vak == null || Number.isNaN(b.w.Vak)) ? 9999 : Number(b.w.Vak);
      if (vakA !== vakB) return vakA - vakB;

      const nameA = (a.w.Wijn || "").toLowerCase();
      const nameB = (b.w.Wijn || "").toLowerCase();
      if (nameA !== nameB) return nameA.localeCompare(nameB);

      const yA = parseInt(a.w.Jaargang, 10) || 0;
      const yB = parseInt(b.w.Jaargang, 10) || 0;
      return yB - yA;
    });

  rows.forEach(({ w, idx }) => {
    const tr = document.createElement("tr");
    const onDrink = isOnDrink(w.Drinkvenster);

    const locationMissing = (w.Vak === null || w.Vak === undefined || w.Vak === "" || Number.isNaN(w.Vak));
    const vakDisplay = locationMissing ? '<span class="tag tag-danger">Geen vak!</span>' : (w.Vak ?? "");

    let voorraadBadge = "";
    if ((w.Aantal || 0) <= 0) voorraadBadge = '<span class="tag tag-danger">Op</span>';
    else if (w.Aantal === 1) voorraadBadge = '<span class="tag tag-danger">Laatste fles</span>';
    else if (w.Aantal <= 3) voorraadBadge = '<span class="tag tag-ok">Lage voorraad</span>';

    let drinkBadge = "";
    if (onDrink && currentView === "all") drinkBadge = '<span class="chip-badge">Nu op dronk</span>';

    const price = w.PrijsHuidig != null ? Number(w.PrijsHuidig)
      : w.PrijsAankoop != null ? Number(w.PrijsAankoop)
      : null;

    const priceText = (price != null && !isNaN(price)) ? price.toFixed(2) : "‚Äî";
    const aantal = Number(w.Aantal || 0);
    const value = (price != null && !isNaN(price) && !isNaN(aantal)) ? (aantal * price) : null;
    const valueText = value != null ? `‚Ç¨ ${value.toFixed(0)}` : "‚Äî";

    let infoBadge = "";
    if (price == null || isNaN(price)) infoBadge += '<span class="tag">Geen prijs</span>';
    if (!w.Drinkvenster) infoBadge += '<span class="tag">Geen drinkvenster</span>';

    const type = w.Type || guessType(w.Wijn);
    const typeLabel = (type === "wit") ? "Wit"
      : (type === "rood") ? "Rood"
      : (type === "bubbels") ? "Mousserend"
      : (type === "rose") ? "Ros√©"
      : "";

    tr.innerHTML = `
      <td>${vakDisplay}</td>
      <td>
        <div><strong>${w.Wijn || ""}</strong></div>
        <div class="small">
          ${typeLabel ? `<span class="tag">${typeLabel}</span>` : ""}
          <div style="margin-top:4px;">
            ${drinkBadge} ${infoBadge}
          </div>
        </div>
      </td>
      <td>${w.Jaargang || ""}</td>
      <td>
        <div>${w.Aantal ?? 0}</div>
        <div>${voorraadBadge}</div>
      </td>
      <td>${priceText}</td>
      <td>${valueText}</td>
      <td>${w.Drinkvenster || ""}</td>
      <td>
        <div class="inline-actions">
          <button class="btn-small" onclick="takeBottle(${idx})">Fles genomen</button>
          <button class="btn-small" onclick="editLocation(${idx})">Locatie</button>
          <button class="btn-small" onclick="editPrice(${idx})">Prijs</button>
          <button class="btn-small" onclick="autoFillDrinkWindow(${idx})">Auto DV</button>
          <button class="btn-small" onclick="autoFillFoodpairing(${idx})">Auto FP</button>
          <button class="btn-small" onclick="editType(${idx})">Type</button>
          <button class="btn-small" onclick="editWine(${idx})">Bewerken</button>
          <button class="btn-small" onclick="deleteWine(${idx})">Verwijderen</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
       // Mobile cards rendering (iPhone)
    if (cards) {
      const vakText = locationMissing ? "Geen vak" : `Vak ${w.Vak}`;
      const yearText = w.Jaargang ? String(w.Jaargang) : "Jaargang n.v.t.";
      const dvText = w.Drinkvenster ? `Drinkvenster: ${w.Drinkvenster}` : "Geen drinkvenster";
      const priceInfo = (price != null && !isNaN(price)) ? `‚Ç¨ ${price.toFixed(2)}/fles` : "Geen prijs";

     const card = document.createElement("div");
card.className = "wine-card";

const showFooterLine = (w.Drinkvenster || (price != null && !isNaN(price)));

card.innerHTML = `
  <div class="wine-top">
    <div class="wine-left">
      <div class="wine-title">${w.Wijn || ""}</div>
      <div class="wine-meta">${typeLabel ? typeLabel + " ¬∑ " : ""}${yearText} ¬∑ ${vakText}</div>
      <div class="wine-badges">
        ${onDrink ? `<span class="chip-badge">Nu op dronk</span>` : ""}
        ${voorraadBadge || ""}
        ${(price == null || isNaN(price)) ? `<span class="tag">Geen prijs</span>` : ""}
        ${(!w.Drinkvenster) ? `<span class="tag">Geen drinkvenster</span>` : ""}
      </div>
    </div>

    <div class="wine-right">
      <div class="qty">${w.Aantal ?? 0}</div>
    </div>
  </div>

  <div class="actions-primary">
    <button class="btn-action" onclick="takeBottle(${idx})">Fles genomen</button>
    <button class="btn-action" onclick="editLocation(${idx})">Locatie</button>

    <details class="more-actions">
      <summary>Meer‚Ä¶</summary>
      <div class="more-grid">
        <button class="btn-action" onclick="editPrice(${idx})">Prijs</button>
        <button class="btn-action" onclick="autoFillDrinkWindow(${idx})">Auto DV</button>
        <button class="btn-action" onclick="autoFillFoodpairing(${idx})">Auto FP</button>
        <button class="btn-action" onclick="editType(${idx})">Type</button>
        <button class="btn-action" onclick="editWine(${idx})">Bewerken</button>
        <button class="btn-action" onclick="deleteWine(${idx})" style="border-color: rgba(209,39,39,.35); color: var(--danger);">Verwijderen</button>
      </div>
    </details>
  </div>

  ${showFooterLine ? `
    <div class="small wine-footer">
      ${w.Drinkvenster ? `Drinkvenster: ${w.Drinkvenster}` : ""}
      ${(w.Drinkvenster && price != null && !isNaN(price)) ? " ¬∑ " : ""}
      ${(price != null && !isNaN(price)) ? `‚Ç¨ ${price.toFixed(2)}/fles` : ""}
    </div>
  ` : ""}
`;

cards.appendChild(card);

    }
  });

  updateSummary();
}

/* Filters */
function quickFilter(type) {
  document.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
  const selected = Array.from(document.querySelectorAll(".pill")).find(p => p.getAttribute("data-type") === type);
  if (selected) selected.classList.add("active");
  renderTable();
}
function clearTypeFilter() {
  document.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
  renderTable();
}
function resetFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("vakFilter").value = "";
  document.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
  setView("all");
  renderTable();
}

/* Acties */
function takeBottle(idx) {
  const w = wines[idx];
  if (!w) return;
  if (!w.Aantal || w.Aantal <= 0) { alert("Er zijn geen flessen meer in voorraad."); return; }
  if (!confirm("Bevestig: 1 fles genomen van\n" + (w.Wijn || "onbekende wijn") + " (vak " + (w.Vak ?? "?") + ")")) return;
  w.Aantal = (w.Aantal || 0) - 1;
  w.LastDrunk = new Date().toISOString();
  saveData();
  renderTable();
}

function editLocation(idx) {
  const w = wines[idx];
  if (!w) return;
  const currentVak = (w.Vak != null && !Number.isNaN(w.Vak)) ? w.Vak : "";
  const newVak = prompt("Nieuwe vaklocatie:", currentVak);
  if (newVak === null) return;
  if (String(newVak).trim() === "") { alert("Vak mag niet leeg zijn."); return; }
  const vakNum = parseInt(String(newVak).trim(), 10);
  w.Vak = isNaN(vakNum) ? String(newVak).trim() : vakNum;
  saveData(); fillVakFilter(); renderTable();
}

function editPrice(idx) {
  const w = wines[idx];
  if (!w) return;
  const currentPrice = w.PrijsHuidig != null ? w.PrijsHuidig : w.PrijsAankoop;
  const input = prompt("Nieuwe prijs per fles (in ‚Ç¨):", currentPrice != null ? String(currentPrice) : "");
  if (input === null) return;
  const val = parseFloat(String(input).replace(",", "."));
  if (isNaN(val) || val < 0) { alert("Ongeldige prijs."); return; }
  w.PrijsHuidig = val;
  saveData(); renderTable();
}

function editType(idx) {
  const w = wines[idx];
  if (!w) return;
  const current = w.Type || guessType(w.Wijn) || "";
  const input = prompt("Type: wit, rood, ros√©, mousserend", current);
  if (input === null) return;

  const val = input.trim().toLowerCase();
  let normalized = null;
  if (val === "wit" || val === "white") normalized = "wit";
  else if (val === "rood" || val === "red") normalized = "rood";
  else if (val === "rose" || val === "ros√©") normalized = "rose";
  else if (val === "mousserend" || val === "bubbels" || val === "sparkling") normalized = "bubbels";

  if (!normalized) { alert("Onbekend type."); return; }
  w.Type = normalized;
  saveData(); renderTable();
}

function autoFillDrinkWindow(idx) {
  const w = wines[idx];
  if (!w) return;
  const suggestion = estimateDrinkWindowForWine(w);
  if (!suggestion) { alert("Geen automatisch drinkvenster mogelijk (jaargang ontbreekt)."); return; }
  if (w.Drinkvenster && !confirm("Overschrijven?\nHuidig: " + w.Drinkvenster + "\nNieuw: " + suggestion)) return;
  w.Drinkvenster = suggestion;
  saveData(); renderTable();
}

function autoFillAllDrinkWindows() {
  let changed = 0;
  wines.forEach(w => {
    const current = w.Drinkvenster ? String(w.Drinkvenster).trim() : "";
    if (!current) {
      const suggestion = estimateDrinkWindowForWine(w);
      if (suggestion) { w.Drinkvenster = suggestion; changed++; }
    }
  });
  saveData(); renderTable();
  alert(changed > 0 ? (changed + " wijnen kregen een drinkvenster.") : "Geen wijnen zonder drinkvenster gevonden.");
}

function autoFillFoodpairing(idx) {
  const w = wines[idx];
  if (!w) return;
  const suggestion = estimateFoodpairingForWine(w);
  if (!suggestion) { alert("Geen automatische foodpairing beschikbaar."); return; }
  if (w.Foodpairing && !confirm("Overschrijven?\nHuidig: " + w.Foodpairing + "\nNieuw: " + suggestion)) return;
  w.Foodpairing = suggestion;
  saveData(); renderTable();
}

function autoFillAllFoodpairings() {
  let changed = 0;
  wines.forEach(w => {
    const current = w.Foodpairing ? String(w.Foodpairing).trim() : "";
    if (!current) {
      const suggestion = estimateFoodpairingForWine(w);
      if (suggestion) { w.Foodpairing = suggestion; changed++; }
    }
  });
  saveData(); renderTable();
  alert(changed > 0 ? (changed + " wijnen kregen foodpairing.") : "Geen wijnen zonder foodpairing gevonden.");
}

function editWine(idx) {
  const w = wines[idx];
  if (!w) return;

  const newName = prompt("Nieuwe naam (leeg = ongewijzigd):", w.Wijn || "");
  if (newName === null) return;
  if (newName.trim() !== "") w.Wijn = newName.trim();

  const newYear = prompt("Nieuwe jaargang (leeg = ongewijzigd):", w.Jaargang != null ? String(w.Jaargang) : "");
  if (newYear === null) return;
  if (newYear.trim() !== "") {
    const yr = parseInt(newYear.trim(), 10);
    if (!isNaN(yr)) w.Jaargang = yr;
  }

  const newVak = prompt("Nieuw vak (leeg = ongewijzigd):", (w.Vak != null && !Number.isNaN(w.Vak)) ? String(w.Vak) : "");
  if (newVak === null) return;
  if (newVak.trim() !== "") {
    const vakNum = parseInt(newVak.trim(), 10);
    w.Vak = isNaN(vakNum) ? newVak.trim() : vakNum;
  }

  const newQty = prompt("Nieuw aantal (leeg = ongewijzigd):", w.Aantal != null ? String(w.Aantal) : "");
  if (newQty === null) return;
  if (newQty.trim() !== "") {
    const q = parseInt(newQty.trim(), 10);
    if (!isNaN(q) && q >= 0) w.Aantal = q;
  }

  const newDV = prompt("Nieuw drinkvenster (leeg = ongewijzigd):", w.Drinkvenster || "");
  if (newDV === null) return;
  if (newDV.trim() !== "") w.Drinkvenster = newDV.trim();

  const newFP = prompt("Nieuwe foodpairing (leeg = ongewijzigd):", w.Foodpairing || "");
  if (newFP === null) return;
  if (newFP.trim() !== "") w.Foodpairing = newFP.trim();

  const newNotes = prompt("Nieuwe notities (leeg = ongewijzigd):", w.Notities || "");
  if (newNotes === null) return;
  if (newNotes.trim() !== "") w.Notities = newNotes.trim();

  if (!w.Type) w.Type = guessType(w.Wijn);

  saveData(); fillVakFilter(); renderTable();
}

function deleteWine(idx) {
  const w = wines[idx];
  if (!w) return;
  const ok = confirm("Ben je zeker dat je deze wijn volledig wilt verwijderen?\n\n" + (w.Wijn || "Onbekende wijn"));
  if (!ok) return;
  wines.splice(idx, 1);
  saveData(); fillVakFilter(); renderTable();
}

/* Sommelier */
function setDishAndSuggest(text) {
  document.getElementById("dishInput").value = text;
  suggestWine();
}

function formatLastDrunk(last) {
  if (!last) return "";
  const d = new Date(last);
  if (isNaN(d.getTime())) return "";
  return d.toLocaleDateString("nl-BE");
}

function suggestWine() {
  const dish = (document.getElementById("dishInput").value || "").toLowerCase();
  const result = document.getElementById("sommelierResult");
  result.innerHTML = "";

  if (!dish) {
    result.innerHTML = "<div class='sommelier-result'>Geef een gerecht in om advies te krijgen.</div>";
    return;
  }

  let candidates = wines.filter(w => (w.Aantal || 0) > 0);

  if (dish.includes("kip") || dish.includes("poulet") || dish.includes("gevogelte")) {
    candidates = candidates.filter(w => guessType(w.Wijn) === "wit" || (w.Foodpairing || "").toLowerCase().includes("kip"));
  } else if (dish.includes("rund") || dish.includes("steak") || dish.includes("c√¥te") || dish.includes("os")) {
    candidates = candidates.filter(w => guessType(w.Wijn) === "rood");
  } else if (dish.includes("vis") || dish.includes("zee") || dish.includes("oester") || dish.includes("scampi") || dish.includes("gamba")) {
    candidates = candidates.filter(w => guessType(w.Wijn) === "wit" || guessType(w.Wijn) === "bubbels");
  } else if (dish.includes("aperitief") || dish.includes("aperitif")) {
    candidates = candidates.filter(w => guessType(w.Wijn) === "bubbels" || (w.Foodpairing || "").toLowerCase().includes("aperitief"));
  }

  if (candidates.length === 0) candidates = wines.filter(w => (w.Aantal || 0) > 0);
  if (candidates.length === 0) {
    result.innerHTML = "<div class='sommelier-result'>Er zijn geen flessen meer in voorraad.</div>";
    return;
  }

  const matchWine = candidates.find(w => isOnDrink(w.Drinkvenster)) || candidates[0];

  const weetje = matchWine.Notities || "Geen extra notities, maar dit is een interessante fles uit je kelder.";
  const drink = matchWine.Drinkvenster ? `Drinkvenster: ${matchWine.Drinkvenster}.` : "";
  const serveer = matchWine.Serveertemperatuur ? `Serveer rond ${matchWine.Serveertemperatuur}.` : "";
  const vakInfo = matchWine.Vak ? `De fles ligt in vak ${matchWine.Vak}.` : "Locatie: vak nog niet ingevuld.";
  const lastDrunkText = matchWine.LastDrunk ? `Laatst gedronken op ${formatLastDrunk(matchWine.LastDrunk)}.` : "";

  result.innerHTML = `
    <div class="sommelier-result">
      <strong>Advies:</strong> ${matchWine.Wijn} (jaargang ${matchWine.Jaargang || "n.v.t."})<br>
      ${matchWine.Vak ? `<span class="tag">Vak ${matchWine.Vak}</span>` : `<span class="tag tag-danger">Geen vak</span>`}
      <br><br>
      <strong>Weetje:</strong> ${weetje}<br>
      ${drink} ${serveer} ${lastDrunkText}<br><br>
      <em>${vakInfo}</em>
    </div>
  `;
}

/* Add wine */
function addWine(event) {
  event.preventDefault();
  const vak = document.getElementById("addVak").value.trim();
  const wijn = document.getElementById("addWijn").value.trim();
  const jaargang = document.getElementById("addJaargang").value.trim();
  const aantalVal = document.getElementById("addAantal").value.trim();
  const aankoopPrijsVal = document.getElementById("addAankoopPrijs").value.trim();
  const huidigePrijsVal = document.getElementById("addHuidigePrijs").value.trim();
  const drink = document.getElementById("addDrinkvenster").value.trim();
  const serveer = document.getElementById("addServeer").value.trim();
  const food = document.getElementById("addFood").value.trim();
  const notes = document.getElementById("addNotes").value.trim();
  const typeVal = document.getElementById("addType").value;

  if (!vak || !wijn) { alert("Vak en wijnnaam zijn verplicht."); return; }

  const aantal = aantalVal ? parseInt(aantalVal, 10) : 1;
  const aankoopPrijs = aankoopPrijsVal ? parseFloat(aankoopPrijsVal.replace(",", ".")) : null;
  const huidigePrijs = huidigePrijsVal ? parseFloat(huidigePrijsVal.replace(",", ".")) : null;
  const jaargangNum = jaargang ? parseInt(jaargang, 10) : null;

  const autoDV = drink ? null : estimateDrinkWindowForWine({ Wijn: wijn, Jaargang: jaargangNum });
  const autoFP = food ? null : estimateFoodpairingForWine({ Wijn: wijn });

  const newWine = {
    Vak: parseInt(vak, 10),
    Wijn: wijn,
    Type: typeVal || guessType(wijn),
    Jaargang: jaargangNum,
    Aantal: (!isNaN(aantal) && aantal >= 0) ? aantal : 1,
    PrijsAankoop: (!isNaN(aankoopPrijs) ? aankoopPrijs : null),
    PrijsHuidig: (!isNaN(huidigePrijs) ? huidigePrijs : null),
    Drinkvenster: drink || autoDV || null,
    Serveertemperatuur: serveer || null,
    Foodpairing: food || autoFP || null,
    Notities: notes || null,
    _id: wines.length ? (Math.max(...wines.map(w => w._id || 0)) + 1) : 1
  };

  wines.push(newWine);
  saveData(); fillVakFilter(); renderTable();
  clearAddForm();
}

function clearAddForm() {
  document.getElementById("addForm").reset();
  document.getElementById("addAantal").value = "1";
}

function resetAll() {
  if (!confirm("Alle lokale wijzigingen wissen en terug naar basislijst?")) return;
  // legacy keys opruimen (veilig)
LEGACY_STORAGE_KEYS.forEach(k => localStorage.removeItem(k));

  initData();
  fillVakFilter();
  resetFilters();
}

/* Init */
(async function boot() {
  await initData();
  fillVakFilter();
  renderTable();
})();

</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js")
    .then(() => console.log("Service worker geregistreerd"))
    .catch(err => console.error("SW error:", err));
}
</script>

</body>
</html>
